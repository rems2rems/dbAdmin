// Generated by CoffeeScript 1.10.0
(function() {
  var Promise, config, createBundle, dbDriver, expect, instance;

  expect = require('must');

  require('../../../openbeelab-util/javascript/objectUtils').install();

  config = require('../config').clone();

  createBundle = require('../create_bundle');

  dbDriver = require('../../../openbeelab-db-util/javascript/dbDriver');

  Promise = require('promise');

  instance = null;

  describe("create a bundled db", function() {
    before(function(done) {
      var mockCouch;
      mockCouch = require('../../../mock-couch');
      instance = mockCouch.createServer();
      instance.listen(config.database.port);
      instance.addDB("_users");
      return done();
    });
    after(function(done) {
      instance.close();
      return done();
    });
    return it("should work", function(done) {
      var dbServer;
      dbServer = dbDriver.connectToServer(config.database);
      return createBundle(config, dbServer).then(function(logs) {
        var configDb, dataDb, usersDb;
        expect(logs).to.not.be(null);
        logs.length.must.be.above(5);
        configDb = dbServer.useDb(config.database.name + "_config");
        dataDb = dbServer.useDb(config.database.name + "_data");
        usersDb = dbServer.useDb("_users");
        configDb.exists().must.eventually.be["true"]();
        dataDb.exists().must.eventually.be["true"]();
        usersDb.get('org.couchdb.user:' + config.database.name + '_admin').must.eventually.not.be(null);
        return done();
      })["catch"](function(err) {
        return done(err);
      });
    });
  });

}).call(this);
