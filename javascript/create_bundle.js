// Generated by CoffeeScript 1.10.0
(function() {
  var util;

  util = require('util');

  module.exports = function(config, dbServer) {
    var Promise, buildDbSecurityObject, configDb, createUsers, createViews, dataDb, dbName, insert_beehouse, insert_location, insert_stand, logs, usersDb;
    insert_location = require('./insert_location');
    insert_stand = require('./insert_stand');
    insert_beehouse = require('./insert_beehouse');
    createViews = require('./create_views');
    createUsers = require('./create_users');
    buildDbSecurityObject = require('./buildDbSecurityObject');
    Promise = require("promise");
    dbName = config.database.name;
    usersDb = dbServer.useDb("_users");
    configDb = dbServer.useDb(config.database.name + "_config");
    dataDb = dbServer.useDb(config.database.name + "_data");
    logs = [];
    return configDb.create().then(function() {
      logs.push("config db created.");
      return dataDb.create();
    }).then(function() {
      var secu;
      logs.push("data db created.");
      secu = config.database.securityObject;
      secu = buildDbSecurityObject(secu, config.database.name);
      return Promise.all([configDb.save(secu), dataDb.save(secu)]);
    }).then(function() {
      logs.push("security object created, dbs are protected.");
      return createViews(configDb, "config");
    }).then(function() {
      logs.push("config db views created.");
      return createUsers(usersDb, dbName);
    }).then(function(users) {
      var location;
      logs.push("admin credentials:");
      logs.push("login:" + users.admin.name + ",password:" + users.admin.password);
      logs.push("uploader credentials:");
      logs.push("login:" + users.uploader.name + ",password:" + users.uploader.password);
      logs.push("users created.");
      location = config.database.configObjects.location;
      return insert_location(configDb, location);
    }).then(function() {
      var p1, p2;
      logs.push("location created.");
      p1 = configDb.save(config.database.configObjects.beehouse_model);
      p2 = configDb.save(config.database.configObjects.beehouse);
      return Promise.all([p1, p2]);
    }).then(function() {
      var stand;
      logs.push("beehouse created.");
      stand = config.database.configObjects.stand;
      return configDb.save(stand);
    }).then(function() {
      logs.push("stand created.");
      return createViews(dataDb, "data");
    }).then(function() {
      logs.push("data db views created");
      return logs;
    })["catch"](function(err) {
      return console.log("err:" + util.inspect(err, true, 5, true));
    });
  };

}).call(this);
