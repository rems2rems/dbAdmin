// Generated by CoffeeScript 1.10.0
(function() {
  module.exports = function(config, dbServer) {
    var Promise, configDb, createUsers, createViews, dataDb, dbName, fn, insert_beehouse, insert_location, insert_stand, j, len, ref, user, usersDb, usersPromises;
    insert_location = require('./insert_location');
    insert_stand = require('./insert_stand');
    insert_beehouse = require('./insert_beehouse');
    createViews = require('./create_views');
    createUsers = require('./create_users');
    Promise = require("promise");
    dbName = config.database.name;
    usersDb = dbServer.useDb("_users");
    configDb = dbServer.useDb(config.database.name + "_config");
    dataDb = dbServer.useDb(config.database.name + "_data");
    usersPromises = [];
    ref = config.database.users;
    fn = function(user) {
      var i, k, len1, ref1, role, userPromise;
      ref1 = user.roles;
      for (i = k = 0, len1 = ref1.length; k < len1; i = ++k) {
        role = ref1[i];
        user.roles[i] = dbName + "/" + role;
      }
      userPromise = usersDb.save(user);
      userPromise.then(function(res) {
        console.log("user " + user.name + " created.");
        return user;
      });
      return usersPromises.push(userPromise);
    };
    for (j = 0, len = ref.length; j < len; j++) {
      user = ref[j];
      fn(user);
    }
    return Promise.all(usersPromises).then(function() {
      return configDb.create();
    }).then(function() {
      var i, k, l, len1, len2, ref1, ref2, role, secu;
      secu = config.database.securityObject;
      ref1 = secu.admins.roles;
      for (i = k = 0, len1 = ref1.length; k < len1; i = ++k) {
        role = ref1[i];
        secu.admins.roles[i] = dbName + "/" + role;
      }
      ref2 = secu.members.roles;
      for (i = l = 0, len2 = ref2.length; l < len2; i = ++l) {
        role = ref2[i];
        secu.members.roles[i] = dbName + "/" + role;
      }
      return configDb.save(secu);
    }).then(function() {
      return createViews(configDb, "config");
    }).then(function() {
      return createUsers(usersDb, dbName);
    }).then(function(users) {
      console.log(users);
      console.log("dbAdmin login:" + users.admin.name);
      console.log("dbAdmin password:" + users.admin.password);
      console.log("dbUploader login:" + users.uploader.name);
      console.log("dbUploader password:" + users.uploader.password);
      return console.log("config db created.");
    }).then(function() {
      var location;
      location = config.database.configObjects.location;
      return insert_location(configDb, location);
    }).then(function() {
      var p1, p2;
      console.log("location created.");
      p1 = configDb.save(config.database.configObjects.beehouse_model);
      p2 = configDb.save(config.database.configObjects.beehouse);
      return Promise.all([p1, p2]);
    }).then(function() {
      var stand;
      console.log("beehouse created.");
      stand = config.database.configObjects.stand;
      return configDb.save(stand);
    }).then(function() {
      console.log("stand created.");
      return dataDb.create();
    }).then(function() {
      return createViews(dataDb, "data");
    }).then(function() {
      return console.log("data db created.");
    });
  };

}).call(this);
